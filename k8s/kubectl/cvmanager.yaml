---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: cvmanagerapp
  namespace: "kube-system"
  labels:
    app: cvmanager
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cvmanager
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
  minReadySeconds: 30
  template:
    metadata:
      labels:
        app: cvmanager
        component: cvmanagerapp
    spec:
      nodeSelector:
        "node-role.kubernetes.io/master": ""
      tolerations:
        - key: "node-role.kubernetes.io/master"
          effect: NoSchedule
      containers:
        - name: "cvmanagerapp-container"
          image: "nearmap/cvmanager:latest"
          imagePullPolicy: Always
          ports:
            - name: http
              protocol: TCP
              containerPort: 8081
          args:
            - run
            - "--configmap-key=kube-system/cvmanager"
            - "--history=true"
            - "--cv-img-repo=nearmap/cvmanager"
          env:
            - name: NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: STATS_HOST
              valueFrom:
                fieldRef:
                  fieldPath: status.hostIP
          livenessProbe:
            httpGet:
              path: /alive
              port: http
          readinessProbe:
            httpGet:
              path: /alive
              port: http
---
kind: Service
apiVersion: v1
metadata:
  name: cvmanagerapp
  namespace: "kube-system"
  labels:
    app: cvmanager
spec:
  type: NodePort
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app: cvmanager
---
kind: ContainerVersion
apiVersion: custom.k8s.io/v1
metadata:
  name: "cvmanager-cv"
  namespace: "kube-system"
spec:
  imageRepo: nearmap/cvmanager
  tag: latest
  checkFrequency: 5
  selector:
    cvapp: cvmanagercv
  container: "cvmanagerapp-container"
  config:
    name: cvmanager
    key: version
---
kind: ConfigMap
apiVersion: v1
data:
  version: latest
metadata:
  name: cvmanager
  namespace: "kube-system"
